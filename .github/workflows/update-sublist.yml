name: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Sublist Ø¨Ø±Ø§ÛŒ Mihomo

on:
  schedule:
    - cron: '0 0 * * *'  # Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Ø±ÙˆØ² Ø±Ø£Ø³ Ø³Ø§Ø¹Øª Û°Û°:Û°Û° UTC
  workflow_dispatch:     # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  update-sublist:
    runs-on: ubuntu-latest

    steps:
      - name: Ú©Ù„ÙˆÙ† Ú©Ø±Ø¯Ù† Ø±ÛŒÙ¾Ùˆ
        uses: actions/checkout@v3

      - name: Ù†ØµØ¨ Ù¾Ø§ÛŒØªÙˆÙ†
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Ù†ØµØ¨ PyYAML
        run: pip install pyyaml

      - name: Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
        run: |
          import os
          import yaml

          url_file = "Simple_URL_List.txt"
          template_file = "mihomo_template.txt"
          output_dir = "Sublist"
          cache_file = ".last_urls.txt"

          if not os.path.exists(output_dir):
              os.makedirs(output_dir)

          # Ø®ÙˆØ§Ù†Ø¯Ù† URLÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
          previous = {}
          if os.path.exists(cache_file):
              with open(cache_file, "r") as f:
                  for line in f:
                      name, old_url = line.strip().split("|", 1)
                      previous[name] = old_url

          new_cache = []
          changes_detected = False

          with open(url_file, "r") as f:
              lines = [line.strip() for line in f if line.strip()]

          for line in lines:
              if "|" not in line:
                  continue
              filename, new_url = line.split("|", 1)
              old_url = previous.get(filename)
              new_cache.append(f"{filename}|{new_url}")

              if new_url != old_url:
                  changes_detected = True
                  print(f"ğŸ”„ URL ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ ÛŒØ§ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„: {filename}")

                  # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ…Ù¾Ù„ÛŒØª Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ URL
                  with open(template_file, "r") as tf:
                      data = yaml.safe_load(tf)

                  data["proxy-providers"]["proxy"]["url"] = new_url

                  # Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯
                  output_path = os.path.join(output_dir, filename)
                  with open(output_path, "w", encoding="utf-8") as outf:
                      yaml.dump(data, outf, default_flow_style=False, allow_unicode=True)

          # Ø°Ø®ÛŒØ±Ù‡ URLÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ú©Ø´
          with open(cache_file, "w") as f:
              f.write("\n".join(new_cache))

          if not changes_detected:
              print("âœ… Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¯Ø± URLÙ‡Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯.")

        shell: python

      - name: Ú©Ø§Ù…ÛŒØª Ùˆ Ù¾ÙˆØ´ Ú©Ø±Ø¯Ù† Ø§Ú¯Ø± ÙØ§ÛŒÙ„ÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨ÙˆØ¯
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Sublist/ .last_urls.txt
          git diff --cached --quiet || git commit -m "ğŸ” Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Sublist Ø¨Ø± Ø§Ø³Ø§Ø³ Simple_URL_List.txt"
          git push
